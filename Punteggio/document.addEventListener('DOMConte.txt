document.addEventListener('DOMContentLoaded', function() {
    const budgetMaleElement = document.getElementById('budget-male');
    const budgetFemaleElement = document.getElementById('budget-female');
    const specialtiesContainer = document.getElementById('specialties-container');
    const initialSelection = document.getElementById('initial-selection');
    const submitTeamButton = document.getElementById('submit-team');

    let budgetMale = 200;
    let budgetFemale = 200;
    let selectedMaleTeam = {};
    let selectedFemaleTeam = {};
    let teams = JSON.parse(localStorage.getItem('teams')) || [];

    const specialties = [
        "100 metri", "200 metri", "400 metri", "800 metri", "1500 metri", 
        "5000 metri", "10000 metri", "Maratona", "110 hs", "400 hs", 
        "3000 metri sc", "Salto in alto", "Salto in lungo", "Salto con l'asta", 
        "Salto triplo", "Giavellotto", "Peso", "Disco", "Martello", "Decathlon",
        "20 Km marcia", "4x100", "4x400"
    ];

    // Esempio di dati degli atleti maschili e femminili
    const maleAthletes = {
        "100 metri": [
            { "name": "MARIO ROSSI", "value": 50, "country": "ITA", "dob": "01 GEN 1990" },
            { "name": "LUCA BIANCHI", "value": 55, "country": "ITA", "dob": "15 MAR 1992" }
        ],
        "200 metri": [
            { "name": "GIANLUCA VERDI", "value": 52, "country": "ITA", "dob": "12 APR 1989" }
        ]
    };

    const femaleAthletes = {
        "100 metri": [
            { "name": "GIULIA ROSSI", "value": 48, "country": "ITA", "dob": "01 FEB 1991" },
            { "name": "LAURA BIANCHI", "value": 50, "country": "ITA", "dob": "05 MAG 1993" }
        ],
        "200 metri": [
            { "name": "ELENA VERDI", "value": 49, "country": "ITA", "dob": "20 LUG 1990" }
        ]
    };

    function createAthleteList(gender, athletes) {
        specialtiesContainer.innerHTML = '';
        specialties.forEach(specialty => {
            if (athletes[specialty]) {
                const specialtyDiv = document.createElement('div');
                specialtyDiv.className = 'specialty';
                specialtyDiv.innerHTML = `<h3>${specialty}</h3>`;
                
                athletes[specialty].sort((a, b) => b.value - a.value).forEach(athlete => {
                    const athleteDiv = document.createElement('div');
                    athleteDiv.className = 'athlete';
                    athleteDiv.innerText = `${athlete.name} (${athlete.country}) - ${athlete.value} crediti`;
                    athleteDiv.addEventListener('click', () => selectAthlete(gender, specialty, athlete));
                    specialtyDiv.appendChild(athleteDiv);
                });

                specialtiesContainer.appendChild(specialtyDiv);
            }
        });
    }

    function selectAthlete(gender, specialty, athlete) {
        const budgetElement = gender === 'male' ? budgetMaleElement : budgetFemaleElement;
        let budget = gender === 'male' ? budgetMale : budgetFemale;
        let selectedTeam = gender === 'male' ? selectedMaleTeam : selectedFemaleTeam;

        if (selectedTeam[specialty]) {
            budget += selectedTeam[specialty].value;
        }

        if (budget < athlete.value) {
            alert('Budget insufficiente');
            return;
        }

        budget -= athlete.value;
        selectedTeam[specialty] = athlete;
        budgetElement.innerText = `Budget disponibile: ${budget}`;

        if (gender === 'male') {
            budgetMale = budget;
            selectedMaleTeam = selectedTeam;
        } else {
            budgetFemale = budget;
            selectedFemaleTeam = selectedTeam;
        }

        updateSubmitButton();
    }

    function updateSubmitButton() {
        const maleComplete = specialties.every(s => selectedMaleTeam[s]);
        const femaleComplete = specialties.every(s => selectedFemaleTeam[s]);
        submitTeamButton.disabled = !(maleComplete && femaleComplete); // Enable only if both teams are complete
    }

    function validateSelection() {
        const missingMaleSpecialties = specialties.filter(s => !selectedMaleTeam[s]);
        const missingFemaleSpecialties = specialties.filter(s => !selectedFemaleTeam[s]);
        
        if (missingMaleSpecialties.length > 0 || missingFemaleSpecialties.length > 0) {
            let alertMessage = '';
            if (missingMaleSpecialties.length > 0) {
                alertMessage += 'Per gli uomini, manca la selezione delle seguenti specialità: ' + missingMaleSpecialties.join(', ') + '.\n';
            }
            if (missingFemaleSpecialties.length > 0) {
                alertMessage += 'Per le donne, manca la selezione delle seguenti specialità: ' + missingFemaleSpecialties.join(', ') + '.';
            }
            alert(alertMessage);
            return false;
        }
        return true;
    }

    submitTeamButton.addEventListener('click', function() {
        if (validateSelection()) {
            alert('Selezione completata con successo!');
            // Add code here to finalize the selection, e.g., submit a form
        }
    });

    document.getElementById('uomini').addEventListener('click', () => {
        initialSelection.style.display = 'none';
        createAthleteList('male', maleAthletes);
    });

    document.getElementById('donne').addEventListener('click', () => {
        initialSelection.style.display = 'none';
        createAthleteList('female', femaleAthletes);
    });

    document.getElementById('home').addEventListener('click', () => {
        initialSelection.style.display = 'block';
        specialtiesContainer.innerHTML = '';
    });

    document.getElementById('add-team').addEventListener('click', () => {
        const name = document.getElementById('team-name').value;
        const maleCaptain = document.getElementById('capitano-maschile').value;
        const femaleCaptain = document.getElementById('capitano-femminile').value;

        if (!name || !maleCaptain || !femaleCaptain) {
            alert('Completa tutti i campi');
            return;
        }

        if (teams.find(t => t.name === name)) {
            alert('Una squadra con questo nome esiste già');
            return;
        }

        const newTeam = {
            name,
            maleCaptain,
            femaleCaptain,
            maleTeam: selectedMaleTeam,
            femaleTeam: selectedFemaleTeam,
            malePoints: 0,
            femalePoints: 0
        };

        teams.push(newTeam);
        localStorage.setItem('teams', JSON.stringify(teams));
        budgetMale = 200; // Reset budget for new team
        budgetFemale = 200; // Reset budget for new team
        updateBudget();
    });

    document.getElementById('show-teams').addEventListener('click', () => {
        const teamsContainer = document.getElementById('teams-container');
        teamsContainer.innerHTML = '';

        teams.forEach(team => {
            teamsContainer.innerHTML += `
                <div class="team-entry">
                    <h3>${team.name}</h3>
                    <p>Capitano Maschile: ${team.maleCaptain}</p>
                    <p>Capitano Femminile: ${team.femaleCaptain}</p>
                    <h4>Atleti Maschili:</h4>
                    ${Object.keys(team.maleTeam).map(specialty => `
                        <h5>${specialty}</h5>
                        <ul>
                            ${team.maleTeam[specialty].map(a => `<li>${a.name}</li>`).join('')}
                        </ul>
                    `).join('')}
                    <h4>Atleti Femminili:</h4>
                    ${Object.keys(team.femaleTeam).map(specialty => `
                        <h5>${specialty}</h5>
                        <ul>
                            ${team.femaleTeam[specialty].map(a => `<li>${a.name}</li>`).join('')}
                        </ul>
                    `).join('')}
                </div>
            `;
        });
    });

    document.getElementById('assign-points').addEventListener('click', () => {
        const name = document.getElementById('athlete-name').value;
        const specialty = document.getElementById('specialty').value;
        const stage = document.getElementById('stage').value;
        const position = parseInt(document.getElementById('position').value, 10);
        const isRecord = document.getElementById('record').checked;
        const isDnf = document.getElementById('dnf').checked;
        const isDq = document.getElementById('dq').checked;

        if (!name || !specialty || !stage || isNaN(position)) {
            alert('Completa tutti i campi');
            return;
        }

        let points = 0;

        if (stage === 'Semifinale') {
            points = 1;
        } else if (stage === 'Finale') {
            if (specialty === "Maratona" || specialty === "Decathlon" || specialty === "20 Km marcia" || specialty === "10000 metri") {
                points = [21, 18, 15, 12, 10, 9, 8, 7, 6, 5, 4, 3][position - 1] || 0;
            } else {
                points = [20, 15, 12, 10, 8, 6, 4, 2, 1][position - 1] || 0;
            }
        }

        if (isDnf) {
            points = 0;
        } else if (isDq) {
            points = 0;
        } else if (isRecord) {
            points *= 2;
        }

        const team = teams.find(t => t.name === name);
        if (team) {
            if (stage === 'Finale') {
                if (team.maleTeam[specialty]) {
                    team.malePoints += points;
                } else if (team.femaleTeam[specialty]) {
                    team.femalePoints += points;
                }
            } else if (stage === 'Semifinale') {
                if (team.maleTeam[specialty]) {
                    team.malePoints += points;
                } else if (team.femaleTeam[specialty]) {
                    team.femalePoints += points;
                }
            }
            localStorage.setItem('teams', JSON.stringify(teams));
            alert('Punti assegnati con successo!');
        } else {
            alert('Squadra non trovata');
        }
    });

    function updateBudget() {
        budgetMaleElement.innerText = `Budget disponibile: ${budgetMale}`;
        budgetFemaleElement.innerText = `Budget disponibile: ${budgetFemale}`;
    }

    updateBudget();
});
